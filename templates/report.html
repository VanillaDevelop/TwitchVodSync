{% extends "templatemain.html" %}

{% block head %}
    <link rel="stylesheet" href="{{  url_for('static', filename='report.css') }}">
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h3>Report Info</h3>
    <h5><strong>Report:</strong> {{ title }}</h5>
    <p>This report runs from <strong>{{ start_time }}</strong> until <strong>{{ end_time }}</strong>.<br />
    <span id="pullno"></span><br/>
    <span id="lastupdate"></span>
    <p/>
    <button class="btn btn-primary" onclick="updateLog()">Update Log</button> <br />
    <p>
    <small>
        You may update the log once every 2 minutes to scan for new pulls. If you or anyone else has updated this log
        within the last 2 minutes, pressing this button will fetch the newest version from the database, but will not
        query FFLogs. Updating the log will leave your stream view intact.
    </small>
    </p>

    <h3>Stream Overview</h3>
    <div class="row">
        <div class="col-md-6 col-12">
            <form id=twitchvod_form" onsubmit="return false;">
                <div class="mb-3">
                    <label class="form-label">Add Twitch VOD or Stream</label>
                    <input type="text" id="twitch_vod" placeholder="Twitch Video ID" class="form-control"/>
                </div>
                <button class="btn btn-primary" onclick="submitTwitchVod()">Add Twitch Video</button>
            </form>
        </div>
        <div class="col-md-6 col">
            <form id=ytvod_form" onsubmit="return false;">
                <div class="mb-3">
                    <label class="form-label">Add YouTube VOD or Stream</label>
                    <input type="text" id="youtube_vod" placeholder="YouTube Video ID" class="form-control"/>
                </div>
                <button onclick="submitYoutubeVod()" class="btn btn-primary">Add YouTube Video</button>
            </form>
        </div>
    </div>

    <h3 class="mt-4">Stream List</h3>
    <div id="streams" class="row">
        <p>Loaded VODs will appear here.</p>
    </div>

    <h3 class="mt-4">Stream View</h3>
    <div id="main_stream">
        <p>The main selected stream will appear here.</p>
    </div>
    <div class="row">
        <div id="streamcontrol" class="col-12 col-md-6 card p-3">
            <h4>Stream Control</h4>
            <p>
                <h6 class="card-title" id="active-fightid"></h6>
                <p class="card-text">
                    <strong id="active-fightname"></strong></br>
                    <span id="active-start"></span> to <span id="active-end"></span> <span id="active-pulltime"></span>
                </p>
            </p>
            <div class="d-flex">
                <button id="active-startbtn" class="btn btn-primary me-2 btn-stream-control">Jump to Start</button>
                <button id="active-endbtn" class="btn btn-primary me-2 btn-stream-control">Jump to Wipe</button>
            </div>
            <div class="d-flex my-2">
                <button class="btn btn-primary me-2 btn-stream-control">Store Custom Offset</button>
                <input class="form-control input-custom-timestamp me-2" type="number" />
                <button class="btn btn-primary me-2 btn-stream-control">Jump to Custom</button>
            </div>

            <h5 class="mt-3">Pull Specific Events</h5>
            <small>Deaths up to 10 seconds before the recorded wipe time are discarded.</small>
            <div id="deaths" class="mt-3">
            </div>
        </div>
    </div>

    <h3 class="mt-4">Report Overview</h3>
        <div id="fights" class="row">
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
    <script src="https://player.twitch.tv/js/embed/v1.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/dayjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/relativeTime.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1/plugin/duration.js"></script>
    <script>
    dayjs.extend(window.dayjs_plugin_relativeTime)
    dayjs.extend(window.dayjs_plugin_duration)

    let videos = {}
    let current_player = null
    let current_start = null
    let encounternames = null
    let pulldata = null
    const start_epoch = parseFloat({{ start_epoch }})

    function onYouTubeIframeAPIReady() {}

    function loadLog(json_data)
    {
        encounternames = json_data["encounternames"]
        pulldata = json_data
        updateFights(json_data["fights"])
        $("#lastupdate").html(`Last updated ${dayjs(json_data["loaded_at"] * 1000).fromNow()} at ${dayjs(json_data["loaded_at"] * 1000).format()}`)
    }

    function updateFights(fights)
    {
        let fighthtml = "";
        for (let i=0;i<fights.length;i++)
        {
            fighthtml += getFightHTML(fights[i])
        }
        $("#fights").html(fighthtml)
        $("#pullno").html(`It contains ${fights.length} pulls.`)
    }

    function getFightHTML(fight)
    {
        return `<div class="col-6 col-lg-4">
            <div class="card my-2">
              <div class="card-body">
                <h5 class="card-title">Fight ${fight["id"]}</h5>
                <p class="card-text">
                    <strong>${encounternames[fight["encounterID"]]}</strong></br>
                    ${fight["timestampStart"]} to ${fight["timestampEnd"]}<br/>
                </p>
                <div>
                    <button class="btn btn-primary" onclick="makeActive(${fight["id"]})">Make Active</button>
                </div>
              </div>
            </div>
        </div>`

        //<input hidden type="text" name="wipe" value="${fight["endTime"]}">
    }

    function getDeathHTML(pull_start, death, player_data)
    {
        return `<p class="align-items-center d-flex">
                <strong class="me-1">Death (${player_data[death["targetID"]]["name"]}) </strong> at ${dayjs.duration(death["timestamp"] - pull_start).format('mm:ss')}
                <button class="btn btn-primary ms-2" onclick="jumpTo(${death['timestamp']})">Jump to</button>
                </p>`

        //<input hidden type="text" name="wipe" value="${fight["endTime"]}">
    }

    function submitTwitchVod()
    {
        let vid_id = $('#twitch_vod').val();
        if(vid_id in videos) return;
        $.ajax({
            async: true,
            type: "GET",
            dataType: 'json',
            url: "/ajax/twitch/vod?id=" + vid_id,
            contentType: "application/json; charset=utf-8",
            success: function (msg) {
                let d = new Date(msg['created_at']);
                videos[msg['id']] = {
                    'timestamp': d.getTime()/1000,
                    'player': "twitch"
                }

                let newNode = document.createElement('div')
                newNode.setAttribute("id", "stream" + msg['id'])
                newNode.setAttribute("class", "twitch col-4 col-lg-3")
                newNode.innerHTML = getStreamHTML(msg['id'], msg['username'], d, "twitch")
                $('#streams').append(newNode);
            }
         });
    }

    function submitYoutubeVod()
    {
        let vid_id = $('#youtube_vod').val();
        if(vid_id in videos) return;
        $.ajax({
            async: true,
            type: "GET",
            dataType: 'json',
            url: "/ajax/youtube/vod?id=" + vid_id,
            contentType: "application/json; charset=utf-8",
            success: function (msg) {
                let d = new Date(msg['created_at']);
                videos[msg['id']] = {
                    'timestamp': d.getTime()/1000,
                    'player': "youtube"
                }

                let newNode = document.createElement('div')
                newNode.setAttribute("id", "stream" + msg['id'])
                newNode.setAttribute("class", "youtube col-4 col-lg-3")
                newNode.innerHTML = getStreamHTML(msg['id'], msg['username'], d, "youtube")
                $('#streams').append(newNode);
            }
         });
    }

    function jumpTo(timestamp)
    {
        if(current_player == null)
            return

        let timer = (start_epoch + timestamp)/1000 - 12;

        if(current_player.constructor.name === "r")
        {
            //twitch player. don't ask me why.
            current_player.seek(timer - current_start)
        }
        else
        {
            current_player.seekTo(timer - current_start)
        }

        document.getElementById("main_stream").scrollIntoView();
    }

    function makeActive(id)
    {
        let pull = pulldata["fights"].find(element => element["id"] === id)
        if(!pull)
            return
        let deaths = pulldata["deaths"].filter(element => element["timestamp"] > pull["startTime"] && element["timestamp"] < pull["endTime"] - 10000)

        $("#active-fightid").html(`Fight ${pull["id"]}`)
        $("#active-fightname").html(encounternames[parseInt(pull["encounterID"])])
        $("#active-start").html(pull["timestampStart"])
        $("#active-end").html(pull["timestampEnd"])

        let deathhtml = ""
        for (let i=0;i<deaths.length;i++)
        {
            deathhtml += getDeathHTML(pull["startTime"], deaths[i], pulldata["player_data"])
        }
        $("#deaths").html(deathhtml)

        $("#active-startbtn").click(function() { jumpTo(pull["startTime"]) })
        $("#active-endbtn").click(function() { jumpTo(pull["endTime"]) })

        document.getElementById("streamcontrol").scrollIntoView();
    }

    function makeStreamPrimary(id)
    {
        if(!(id in videos))
            return;

        if(videos[id]['player'] === "twitch")
        {
                $("#main_stream").html("")
                var options = {
                    width: 1080,
                    height: 720,
                    video: id,
                };
                current_player = new Twitch.Player("main_stream", options);
                player.setVolume(0.5);
        }
        else
        {
            $("#main_stream").html("<div id=\"yt_embed\"></div>")
            current_player = new YT.Player('yt_embed', {
                      height: '720',
                      width: '1080',
                      videoId: id,
                      playerVars: {
                        'playsinline': 1,
                        'autoplay': 1
                      },
                    });

        }
        current_start = videos[id]['timestamp']
    }

    function removeStream(id)
    {
        if(!(id in videos))
            return;

        delete videos[id];

        $(`#stream${id}`).remove()

    }

    function getStreamHTML(id, stream_name, creation_date, platform)
    {
        return `
        <div class="card my-2 stream">
          <div class="card-body d-flex justify-content-between flex-column">
              <div class="d-flex justify-content-between">
                    <h5 class="card-title d-inline">${stream_name}</h5> <img src="/static/${platform}.png" width="32" height="32">
              </div>
              <p>VOD created at ${creation_date}</p>
            <button class="btn btn-primary mb-1" onClick="makeStreamPrimary('${id}')">Make Primary</button>
            <button class="btn btn-danger" onClick="removeStream('${id}')">Remove Stream</button>
          </div>
        </div>`
    }

    function updateLog()
    {
        $.ajax({
            async: true,
            type: "GET",
            dataType: 'json',
            url: "/ajax/fflogs/report?code={{ code }}&update=True",
            contentType: "application/json; charset=utf-8",
            success: function (msg) {
                loadLog(msg)
            }
        })
    }
    </script>
    <script>
        loadLog(JSON.parse("{{ data|safe }}"))
    </script>

{% endblock %}