{% extends "template.html" %}

{% block body %}
    <h3>Stream View</h3>
    {% if twitch_token %}
        <div id="streams" style="height:300px;">

        </div>
        <h5>Add a Twitch VOD</h5>
        <form onsubmit="submitVod(event)" id=twitchvod_form">
            <input type="text" id="twitch_vod" placeholder="Video ID"/>
            <button class="btn btn-primary">Add Twitch VOD</button>
        </form>
    {% else %}
        To add a stream view, you need to authorize with Twitch.
        Sign-in with Twitch
        <form action="/auth/twitch_challenge" method="POST">
            <input hidden type="text" name="code" value="{{code}}"/>
            <button class="btn btn-primary">Sign-in</button>
        </form>
    {% endif %}
    <div><h3>This report was created from {{ start_time }} to {{ end_time }}</h3></div>
    {% for fight in fights %}
        {% if fight["encounterID"] != 0 %}
        <div>
            <strong>Pull from {{fight["timestampStart"]}} to {{fight["timestampEnd"]}}
                ({{encounternames[fight["encounterID"]]}})</strong>
            <form onsubmit="submitWipe(event)">
                <input hidden type="text" name="wipe" value="{{fight["endTime"]}}">
                <button class="btn btn-primary">Show Wipe</button>
            </form>
        </div>
        {% endif %}
    {% endfor %}
{% endblock %}

{% block scripts %}
    <script src= "https://player.twitch.tv/js/embed/v1.js"></script>
    <script>
    videolist = {}
    videonames = {}
    videoplayers = {}

    const start_epoch = parseFloat({{ start_epoch }})

    function submitVod(event)
    {
        event.preventDefault();
        let vid_id = $('#twitch_vod').val();
        if(vid_id in videolist) return;
        $.ajax({
            async: true,
            type: "GET",
            dataType: 'json',
            url: "/ajax/twitch/vod?id=" + vid_id,
            contentType: "application/json; charset=utf-8",
            success: function (msg) {
                let d = new Date(msg['created_at']);
                videolist[msg['id']] = d.getTime();
                videonames[msg['id']] = msg['title'];

                let newNode = document.createElement('div')
                newNode.setAttribute("id", "stream" + msg['id'])
                $('#streams').append(newNode);

                var options = {
                    height: 300,
                    width: 500,
                    video: msg['id'],
                };
                var player = new Twitch.Player("stream" + msg['id'], options);
                player.setVolume(0.5);
                videoplayers[msg['id']] = player
            }
         });
    }

    function submitWipe(event)
    {
        event.preventDefault();
        let formData = new FormData(event.target);
        let timestamp = parseFloat(formData.get('wipe'))
        let pullWipe = start_epoch + timestamp - 10000;

        Object.keys(videolist).forEach(id =>
        {
            videoplayers[id].seek((pullWipe - videolist[id])/1000)
        });
    }
    </script>
{% endblock %}